@using MetaGraffiti.Web.Admin.Models;
@model TrackViewModel2

@Html.Partial("_Nav")

@{
	var edit = Model.SelectedTrack.Track;
	var track = Model.SelectedTrack.TopoTrack;
	var filters = Model.SelectedTrack.Filters;
}

<script>
	var _marker = null;
	var _track = @JsonHelper.GetJson(track);

	$(document).ready(function () {
		initMap();
		loadTrack();

		$(".js-mappable-row").hover(function () {
			if (_marker != null) _marker.setMap(null);

			var index = $(this).index();
			var point = _track.points[index];
			_marker = markPoint(point.lat, point.lng, point.id);
		});

		$(".js-mappable-row").click(function () {
			var index = $(this).index();
			var point = _track.points[index];
			gotoPoint(point.lat, point.lng);
		});
	});

	function loadTrack() {
		var points = _track.points;
		var last = points.length - 1;

		showTrack(points);
		markStart(points[0].lat, points[0].lng);
		markStop(points[last].lat, points[last].lng);
	}
</script>

<div id="map-container">
	<div id="map">
	</div>
</div>

<div class="row">
	<div class="col-sm-6">
		@if (Model.HasConfirmation)
		{
			<div class="alert alert-success">@Model.ConfirmMessage</div>
		}
		@if (Model.HasError)
		{
			<div class="alert alert-danger">@Model.ErrorMessages.First()</div>
		}
		<div class="row">
			<div class="col-sm-6">
				<form method="post" action="@TrackViewModel.GetSaveUrl()">
					<input type="hidden" name="ID" value="@edit.Key" />
					<div class="form-group">
						<div>
							<label for="name">Name</label>
							<span class="float-right">
								<span class="mt-2 badge badge-secondary">
									@track.Points.Count points
								</span>
								<span class="mt-2 badge badge-success">
									@track.Stats.EstimatedKM.ToString("#,##0.0") km
								</span>
								<span class="mt-2 badge badge-info">
									@TextHelper.GetElapsedTime(track.Stats.ElapsedTime)
								</span>
							</span>
						</div>
						<input type="text" class="form-control" name="Name" value="@track.Name">
					</div>
					<div class="form-group">
						<label for="description">Description</label>
						<input type="text" class="form-control" name="Description" value="@track.Description">
					</div>
					<div class="row">
						<div class="col">
							<button type="submit" class="btn btn-success">Save</button>
						</div>
						<div class="col text-right">
							<a href="@TrackViewModel.GetManageUrl()" class="btn btn-secondary">Manage</a>
							<a href="@TrackViewModel.GetDeleteUrl(edit.Key)" class="btn btn-outline-danger js-confirm">Remove</a>
						</div>
					</div>
				</form>
			</div>
			<div class="col-sm-6">
				<form method="post" action="@TrackViewModel.GetFilterUrl()">
					<input type="hidden" name="ID" value="@track.Source" />
					<div class="form-group">
						<div class="row">
							<div class="col">
								<div>
									<label for="start">Start</label>
									<span class="float-right mt-2 badge badge-info">@track.StartLocal</span>
								</div>
								<input type="text" class="form-control" name="StartTimestamp" placeholder="Start Time" value="@track.StartUTC">
							</div>
							<div class="col">
								<div>
									<label for="finish">Finish</label>
									<span class="float-right mt-2 badge badge-info">@track.FinishLocal</span>
								</div>
								<input type="text" class="form-control" name="FinishTimestamp" placeholder="Finish Time" value="@track.FinishUTC">
							</div>
						</div>
					</div>
					<div class="form-group">
						<div class="row">
							<div class="col">
								<label for="MinimumSatellite">Min Satellites</label>
								<input type="text" class="form-control" name="MinimumSatellite" value="@filters.MinimumSatellite">
							</div>
							<div class="col">
								<label for="MaximumVelocity">Max Velocity</label>
								<input type="text" class="form-control" name="MaximumVelocity" value="@filters.MaximumVelocity">
							</div>
							<div class="col">
								<label for="MaximumDilution">Max Dilution</label>
								<input type="text" class="form-control" name="MaximumDilution" value="@filters.MaximumDilution">
							</div>
							<div class="col">
								<div>
									<label>
										Missing DOP
									</label>
								</div>
								<label>
									<input type="checkbox" name="MissingDilution" value="true"> Delete?
								</label>
							</div>
						</div>
					</div>
					<div class="row">
						<div class="col">
							<button type="submit" class="btn btn-primary">Apply Filter</button>
						</div>
						<div class="col text-right">
							<a href="@TrackViewModel.GetRevertUrl(edit.Key)" class="btn btn-outline-warning js-confirm">Revert</a>
						</div>
					</div>
				</form>
			</div>
		</div>

		<br />
		<form method="post" action="@TrackViewModel.GetRemoveUrl()">
			<input type="hidden" name="ID" value="@edit.Key" />
			<table class="table table-striped table-bordered table-sm small">
				<thead>
					<tr class="thead-dark">
						<th>Point #</th>
						<th>Timestamp</th>
						<th>Lat / Long</th>
						<th>Elevation</th>
						<th>Course</th>
						<th>M/S</th>
						<th>GPS</th>
						<th>HDOP</th>
						<th>VDOP</th>
						<th>PDOP</th>
					</tr>
				</thead>
				<tbody>
					@{
						var index = 0;
						foreach (var p in track.Points)
						{
							<tr class="js-mappable-row">
								<td>
									<label>
										<input type="checkbox" name="Points" value="@index" /> @((index + 1).ToString("0000"))
									</label>
								</td>
								<td>@p.Timestamp.Value.ToString("yyyy-MM-dd") @p.Timestamp.Value.ToString("hh:mm:ss tt")</td>
								<td>@p.Latitude.ToString("0.000000"), @p.Longitude.ToString("0.000000")</td>
								<td class="text-center">@((p.Elevation ?? 0).ToString("#,##0"))</td>
								<td class="text-center">@((p.Course ?? 0).ToString("##0"))</td>
								<td class="text-center table-@CssHelper.GetGpxSpeedCss(p.Speed)">@((p.Speed ?? 0).ToString("#,##0.0"))</td>
								<td class="text-center table-@CssHelper.GetGpxSatsCss(p.Sats)">@p.Sats</td>
								<td class="text-center table-@CssHelper.GetGpxDOPCss(p.HDOP)">@p.HDOP</td>
								<td class="text-center table-@CssHelper.GetGpxDOPCss(p.VDOP)">@p.VDOP</td>
								<td class="text-center table-@CssHelper.GetGpxDOPCss(p.PDOP)">@p.PDOP</td>
							</tr>
							index++;
						}
					}
				</tbody>
			</table>
			<button type="submit" class="btn btn-danger">Remove Selected Points</button>
		</form>
		<br />
	</div>
</div>